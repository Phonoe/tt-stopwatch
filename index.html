<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>TT Stopwatch ‚Äì Stable iPad Admin FIXED</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,sans-serif;background:#f4f7fb;padding:20px;color:#222}
h2,h3,h4{text-align:center}

button{
  padding:6px 12px;
  margin:4px;
  border-radius:6px;
  border:1px solid #cfd6df;
  background:#fff;
  cursor:pointer
}
button:hover{background:#eef2ff}

.table-wrapper{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.main-table{
  width:1200px;margin:14px auto;border-collapse:collapse;
  table-layout:fixed;background:#fff;
  box-shadow:0 1px 3px rgba(0,0,0,.08)
}
.rank-table{
  width:900px;margin:14px auto;border-collapse:collapse;
  table-layout:fixed;background:#f8fbff;
  box-shadow:0 1px 3px rgba(0,0,0,.06)
}

th,td{
  border:1px solid #d1d5db;
  padding:6px 4px;
  font-size:12px;
  text-align:center;
  white-space:nowrap
}
th{background:#dbeafe;color:#1e3a8a;font-weight:700}

/* input */
input{
  width:100%;
  box-sizing:border-box;
  font-size:12px;
  padding:3px 4px;
  border:1px solid #cfd6df;
  border-radius:4px
}
.time-input{width:36px;text-align:center}
.race-time{font-weight:600;color:#1e40af}

#intervalMin,#intervalSec{width:60px;text-align:center}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° admin */
#adminButtons{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:8px;
}

/* iPad */
@media (max-width:1024px){
  th,td{font-size:14px}
  input{font-size:14px}
  button{font-size:16px;padding:8px 14px}
  .time-input{width:44px;font-size:16px}
  input,button{touch-action:manipulation}
}

/* ‡∏õ‡∏∏‡πà‡∏° + - */
.main-table button{
  padding:2px 6px;
  font-size:12px;
  margin:2px;
}


</style>
</head>

<body>

<h2>üö¥‚Äç‚ôÇÔ∏è Time Trial ‚Äì Stopwatch</h2>

<p style="text-align:center">
üö¶ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡πà‡∏≤‡∏á
<input type="number" id="intervalMin" value="1"> ‡∏ô‡∏≤‡∏ó‡∏µ
<input type="number" id="intervalSec" value="0"> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
</p>

<!-- üî• ‡∏õ‡∏∏‡πà‡∏° admin ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î -->
<div id="adminButtons">
  <button class="admin-only" onclick="addRider()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
  <button class="admin-only" onclick="removeRider()">‚ûñ ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
  <button class="admin-only" onclick="addCP()">‚ûï Checkpoint</button>
  <button class="admin-only" onclick="removeCP()">‚ûñ Checkpoint</button>
</div>

<div class="table-wrapper">
<table class="main-table">
<thead>
<tr id="headerRow"></tr>
<tr id="subHeaderRow"></tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>

<h3>üìä Ranking</h3>
<div id="rankArea"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBhGD8QUxWeYWJ09ALC2pHb20iGvP1EfXk",
  authDomain: "myteamapp-8d618.firebaseapp.com",
  databaseURL: "https://myteamapp-8d618-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myteamapp-8d618",
  storageBucket: "myteamapp-8d618.firebasestorage.app",
  messagingSenderId: "381011189042",
  appId: "1:381011189042:web:67db84b03ea9dd7263cb2b"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
console.log("Firebase initialized");

// Firebase path
const dataRef = database.ref("race");

dataRef.on("value", (snapshot) => {
  const data = snapshot.val();
  console.log("Firebase snapshot:", data);

  if (!data) return;

  cps = data.cps || [];
  riders = data.riders || [];

  render();
});

let saveTimer = null;

function commitChange(){
  if (!isAdmin) return;

  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    database.ref("race").set({
      cps: cps,
      riders: riders
    });
    console.log("Saved to Firebase");
  }, 300);
}

/* ===== MODE ===== */
const params=new URLSearchParams(location.search);
const isAdmin=params.get("mode")==="admin";

/* ===== DATA ===== */
let riders=[];
let cps=[];

function format(sec){
  if(sec==null||isNaN(sec))return"";
  const m=Math.floor(sec/60);
  const s=Math.floor(sec%60);
  return m+":"+String(s).padStart(2,'0')
}

/* ===== CRUD ===== */
function addRider(){
  riders.push({bib:"",name:"",team:"",cps:cps.map(()=>({m:"",s:""}))});
  render()
}
function removeRider(){if(riders.length)riders.pop();render()}
function addCP(){
  cps.push({name:""});
  riders.forEach(r=>r.cps.push({m:"",s:""}));
  render()
}
function removeCP(){
  if(cps.length>1){
    cps.pop();
    riders.forEach(r=>r.cps.pop());
    render()
  }
}

/* + / - ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ */
function incSec(ri,ci){
  let t=riders[ri].cps[ci];
  t.s=(+t.s||0)+1;
  if(t.s>=60){t.s=0;t.m=(+t.m||0)+1}
  render()
}
function decSec(ri,ci){
  let t=riders[ri].cps[ci];
  t.s=Math.max((+t.s||0)-1,0);
  render()
}

/* ===== RENDER ===== */

function render(){
console.log("render called", cps, riders);
  headerRow.innerHTML=subHeaderRow.innerHTML=table.innerHTML="";

  headerRow.innerHTML+='<th rowspan="2">BIB</th><th rowspan="2">‡∏ä‡∏∑‡πà‡∏≠</th><th rowspan="2">‡∏ó‡∏µ‡∏°</th><th rowspan="2">Gap</th>';
  cps.forEach((cp,i)=>{
    headerRow.innerHTML+=`<th colspan="2">CP${i+1}<br>
    <input value="${cp.name}" ${!isAdmin?"disabled":""}
    onchange="cps[${i}].name=this.value;render()"></th>`;
    subHeaderRow.innerHTML+='<th>Time</th><th>Race</th>';
  });

  const gap=(+intervalMin.value||0)*60+(+intervalSec.value||0);

  riders.forEach((r,ri)=>{
    const g=ri*gap;
    let row=`<tr>
    <td><input value="${r.bib}" ${!isAdmin?"disabled":""}
    onchange="riders[${ri}].bib=this.value;render()"></td>
    <td><input value="${r.name}" ${!isAdmin?"disabled":""}
    onchange="riders[${ri}].name=this.value;render()"></td>
    <td><input value="${r.team}" ${!isAdmin?"disabled":""}
    onchange="riders[${ri}].team=this.value;render()"></td>
    <td>${format(g)}</td>`;

    r.cps.forEach((t,ci)=>{
      const total=t.m!==""&&t.s!==""?(+t.m*60+ +t.s - g):null;
      row+=`
      <td>
        <input class="time-input" value="${t.m}" ${!isAdmin?"disabled":""}
        onchange="riders[${ri}].cps[${ci}].m=this.value;render()"> :
        <input class="time-input" value="${t.s}" ${!isAdmin?"disabled":""}
        onchange="riders[${ri}].cps[${ci}].s=this.value;render()">
        ${isAdmin?`
        <div>
        
        </div>`:""}
      </td>
      <td class="race-time">${format(total)}</td>`;
    });

    row+='</tr>';
    table.innerHTML+=row;
  });

  // üîê ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏° admin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö viewer
  document.querySelectorAll(".admin-only").forEach(b=>{
    b.style.display=isAdmin?"":"none";
  });

  renderRank();

if (isAdmin) commitChange();
}

/* ===== RANK ===== */
function renderRank(){
  rankArea.innerHTML="";
  const gap=(+intervalMin.value||0)*60+(+intervalSec.value||0);

  cps.forEach((cp,ci)=>{
    let arr=[];
    riders.forEach((r,ri)=>{
      const t=r.cps[ci];
      if(t.m===""||t.s==="")return;
      const sec=+t.m*60+ +t.s - ri*gap;
      if(sec>=0)arr.push({bib:r.bib,name:r.name,team:r.team,raw:format(+t.m*60+ +t.s),sec})
    });
    arr.sort((a,b)=>a.sec-b.sec);

    let rows="";
    arr.forEach((r,i)=>{
      rows+=`<tr>
      <td>${i+1}</td><td>${r.bib}</td><td>${r.name}</td><td>${r.team}</td>
      <td>${r.raw}</td><td>${format(r.sec)}</td>
      <td>${i?"+"+format(r.sec-arr[0].sec):"-"}</td>
      <td>${i?"+"+format(r.sec-arr[i-1].sec):"-"}</td>
      </tr>`
    });

    rankArea.innerHTML+=`
    <h4>CP${ci+1} ${cp.name?`(${cp.name})`:""}</h4>
    <table class="rank-table">
    <tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>BIB</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ó‡∏µ‡∏°</th>
    <th>Time</th><th>Race</th><th>Gap Leader</th><th>Gap Prev</th></tr>
    ${rows}</table>`;
  });
}

render();

document.addEventListener("keydown", function(e){
  if(e.key !== "Tab") return;

  const inputs = Array.from(document.querySelectorAll(".timeInput"));
  const index = inputs.indexOf(document.activeElement);
  if(index === -1) return;

  e.preventDefault(); // ‡∏Å‡∏±‡∏ô tab ‡∏´‡∏•‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á

  let next = index + (e.shiftKey ? -1 : 1);
  if(next < 0) next = inputs.length - 1;
  if(next >= inputs.length) next = 0;

  inputs[next].focus();
  inputs[next].select();
});

</script>

</body>
</html>
